<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kamuy - AI Image Editor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .dropzone { border: 3px dashed #adb5bd; border-radius: 12px; background: #f8f9fa; }
    .dropzone:hover { border-color: #0d6efd; background: #f1f3f5; }
    .spinner { display: inline-block; width: 1em; height: 1em; border: 2px solid #f3f3f3; border-top: 2px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; }
    .style-btn {
      @apply px-3 py-1 text-xs font-medium rounded-full border border-gray-300 transition-all duration-200 cursor-pointer;
    }
    .style-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.5rem;
    }
    .share-btn {
      @apply flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-medium transition-all duration-200;
    }
    .share-twitter { @apply bg-black hover:bg-gray-800 text-white; }
    .share-facebook { @apply bg-blue-600 hover:bg-blue-700 text-white; }
    .share-telegram { @apply bg-blue-500 hover:bg-blue-600 text-white; }
    .share-whatsapp { @apply bg-green-500 hover:bg-green-600 text-white; }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 50;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      @apply bg-white rounded-2xl shadow-xl p-6 max-w-sm w-full mx-4;
    }
    .modal-header {
      @apply flex justify-between items-center mb-4;
    }
    .modal-title {
      @apply text-lg font-semibold text-gray-800;
    }
    .close-button {
      @apply text-gray-500 hover:text-gray-700 text-2xl font-bold cursor-pointer;
    }
    .social-grid {
      @apply grid grid-cols-2 gap-3;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @media (max-width: 640px) {
      .style-grid { grid-template-columns: repeat(3, 1fr); }
    }

    /* Vertical Reveal Slider */
    .comparison-container {
      position: relative;
      width: 100%;
      height: auto;
      overflow: hidden;
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
    }
    .comparison-image {
      display: block;
      width: 100%;
      height: auto;
    }
    .image-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      pointer-events: none;
    }
    .image-overlay img {
      width: 100%;
      height: auto;
    }
    .slider-handle {
      position: absolute;
      top: 0;
      left: 50%;
      width: 40px;
      height: 100%;
      cursor: ew-resize;
      z-index: 3;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.8);
      border-left: 1px solid #d1d5db;
      border-right: 1px solid #d1d5db;
    }
    .slider-handle::before {
      content: "‚Üî";
      font-size: 24px;
      color: #4b5563;
      opacity: 0.8;
    }
    .slider-instruction {
      text-align: center;
      font-size: 0.875rem;
      color: #4b5563;
      margin-top: 0.25rem;
      font-style: italic;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
    <div class="p-8">
      <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">‚ú® Kamuy</h1>
      <p class="text-center text-gray-600 mb-6">AI Image Editing, Powered by Qwen</p>

      <!-- Upload -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Upload Image</label>
        <input type="file" id="imageInput" accept="image/*" class="hidden" />
        <div id="dropzone" class="dropzone w-full p-6 text-center cursor-pointer">
          <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
            <path d="M28 8H12a4 4 0 00-4 4v20m32-20a4 4 0 014 4v20M16 16l16 16m-16 0l16-16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <p class="mt-2 text-sm text-gray-600">Click to upload or drag and drop</p>
          <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
        </div>
        <!-- Preview -->
        <div id="imagePreview" class="hidden mt-4 p-2 border rounded-lg bg-gray-50 flex items-center">
          <img id="previewImg" class="h-20 w-20 object-cover rounded" />
          <div class="ml-3">
            <p id="previewName" class="text-sm font-medium text-gray-900"></p>
            <p id="previewSize" class="text-sm text-gray-500"></p>
          </div>
        </div>
      </div>

      <!-- Prompt -->
      <div class="mb-6">
        <label for="prompt" class="block text-sm font-medium text-gray-700 mb-2">Edit Prompt</label>
        <input type="text" id="prompt" placeholder="Change the car color to red" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
      </div>

      <!-- Style Presets -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Style Presets</label>
        <div class="style-grid">
          <button type="button" class="style-btn" onclick="toggleStyle(this, 'anime')">üé® Anime</button>
          <button type="button" class="style-btn" onclick="toggleStyle(this, 'studio ghibli')">üé¨ Ghibli</button>
          <button type="button" class="style-btn" onclick="toggleStyle(this, 'vintage')">üìª Vintage</button>
          <button type="button" class="style-btn" onclick="toggleStyle(this, 'cyberpunk')">üïπÔ∏è Cyberpunk</button>
          <button type="button" class="style-btn" onclick="toggleStyle(this, 'van gogh')">üñºÔ∏è Van Gogh</button>
          <button type="button" class="style-btn" onclick="toggleStyle(this, 'lego')">üß± LEGO</button>
          <button type="button" class="style-btn" onclick="toggleStyle(this, 'pixel art')">üéÆ Pixel</button>
          <button type="button" class="style-btn" onclick="toggleStyle(this, 'sketch')">üñãÔ∏è Sketch</button>
          <button type="button" class="style-btn" onclick="toggleStyle(this, 'glitchcore')">üåå Glitch</button>
          <button type="button" class="style-btn" onclick="toggleStyle(this, 'desert mirage')">üèúÔ∏è Mirage</button>
        </div>
      </div>

      <!-- Edit Button -->
      <button id="editBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
        <i class="fas fa-magic mr-2"></i> Edit Image
      </button>

      <!-- Loading -->
      <div id="loading" class="hidden mt-4 text-center text-gray-600">
        <div class="spinner mr-2"></div> Editing your image...
      </div>

      <!-- Result -->
      <div id="result" class="hidden mt-6">
        <h3 class="text-lg font-medium text-gray-800 mb-2">‚ú® Edited Image</h3>
        <div class="comparison-container relative">
          <img id="beforeImage" class="comparison-image" src="" alt="Original" />
          <div class="image-overlay" id="imageOverlay">
            <img id="afterImage" class="comparison-image" src="" alt="Edited" />
          </div>
          <div class="slider-handle" id="sliderHandle"></div>
        </div>
        <p class="slider-instruction">Drag left/right to compare before/after</p>
        
        <!-- Download Button -->
        <button id="downloadBtn" class="mt-3 w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
          <i class="fas fa-download mr-2"></i> Download Image
        </button>

        <!-- Share Button -->
        <button id="shareBtn" class="mt-3 w-full share-btn share-twitter">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.937 4.937 0 004.604 3.417 9.868 9.868 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63a9.936 9.936 0 002.46-2.548l-.047-.02z"/>
          </svg>
          Share
        </button>
      </div>
    </div>
  </div>

  <!-- Share Modal -->
  <div id="shareModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Share Your Creation</h3>
        <span id="closeModal" class="close-button">&times;</span>
      </div>
      <p class="text-sm text-gray-600 mb-4">Share this amazing edit made with Kamuy!</p>
      <div class="social-grid">
        <button onclick="shareTo('twitter')" class="share-btn share-twitter text-white text-sm">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.937 4.937 0 004.604 3.417 9.868 9.868 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63a9.936 9.936 0 002.46-2.548l-.047-.02z"/>
          </svg>
          X
        </button>
        <button onclick="shareTo('facebook')" class="share-btn share-facebook text-white text-sm">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.943H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
          </svg>
          Facebook
        </button>
        <button onclick="shareTo('telegram')" class="share-btn share-telegram text-white text-sm">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M9.78 18.65l.28-3.49L21.6 3.93c.39-.39.59-.91.55-1.42-.04-.57-.39-1.09-.91-1.31-.23-.1-.47-.15-.72-.15-.08 0-.16.01-.24.03L3.05 7.05C1.84 7.39 1 8.43 1 9.65v.14c0 .29.11.57.3.78L13.6 23.07c.27.22.6.33.94.33.22 0 .44-.06.64-.18.22-.14.37-.36.43-.61.07-.29.01-.59-.16-.84L9.78 18.65z"/>
          </svg>
          Telegram
        </button>
        <button onclick="shareTo('whatsapp')" class="share-btn share-whatsapp text-white text-sm">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.198.297-.766.966-.939 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.668-1.607-.916-2.206-.242-.575-.487-.5-.667-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.474 0 1.457.719 2.864 1.04 3.193.32.327 2.146 3.255 5.196 4.607.709.32 1.242.489 1.694.62.72.212 1.36.198 1.871.124.574-.082 1.758-.719 1.991-1.418.234-.698.234-1.272.16-1.771-.075-.501-.272-.94-.42-1.138z"/>
          </svg>
          WhatsApp
        </button>
      </div>
    </div>
  </div>

  <script>
    const selectedStyles = new Set();
    const promptInput = document.getElementById("prompt");
    const defaultPlaceholder = "Change the car color to red";
    const stylePlaceholders = {
      anime: "Make it anime-style with vibrant colors",
      'studio ghibli': "Transform into a Studio Ghibli scene",
      vintage: "Add vintage film grain and warm tones",
      cyberpunk: "Cyberpunk neon lights and rain effects",
      'van gogh': "Paint in Van Gogh's expressive brushstrokes",
      lego: "Recreate as a detailed LEGO diorama",
      'pixel art': "Convert to 16-bit pixel art style",
      sketch: "Turn into a pencil sketch with cross-hatching",
      glitchcore: "Add digital glitches and RGB splits",
      'desert mirage': "Create a desert mirage with heat haze"
    };

    function updatePlaceholder() {
      if (promptInput.value) return;
      
      const activeStyles = Array.from(selectedStyles);
      if (activeStyles.length === 0) {
        promptInput.placeholder = defaultPlaceholder;
      } else {
        promptInput.placeholder = stylePlaceholders[activeStyles[0]] || defaultPlaceholder;
      }
    }

    function toggleStyle(button, style) {
      const isActive = button.style.backgroundColor === 'rgb(37, 99, 235)';
      if (isActive) {
        button.style.backgroundColor = '';
        button.style.borderColor = '#d1d5db';
        button.style.color = '#1f2937';
        button.style.transform = 'scale(1)';
        selectedStyles.delete(style);
      } else {
        button.style.backgroundColor = '#2563eb';
        button.style.borderColor = '#2563eb';
        button.style.color = 'white';
        button.style.transform = 'scale(1.05)';
        selectedStyles.add(style);
      }
      updatePlaceholder();
      console.log("Toggled:", style, "Active:", Array.from(selectedStyles));
    }

    promptInput.addEventListener('focus', () => {
      if (!promptInput.value) {
        const activeStyles = Array.from(selectedStyles);
        if (activeStyles.length > 0) {
          promptInput.placeholder = "For example: " + stylePlaceholders[activeStyles[0]];
        }
      }
    });

    promptInput.addEventListener('blur', () => {
      if (!promptInput.value) {
        updatePlaceholder();
      }
    });

    // === Vertical Reveal Slider (Mobile Fixed) ===
    const beforeImage = document.getElementById('beforeImage');
    const afterImage = document.getElementById('afterImage');
    const imageOverlay = document.getElementById('imageOverlay');
    const sliderHandle = document.getElementById('sliderHandle');
    let isDragging = false;

    function handleMove(e) {
      if (!isDragging) return;
      
      const container = sliderHandle.parentElement;
      const rect = container.getBoundingClientRect();
      const clientX = e.clientX || (e.touches && e.touches[0].clientX);
      if (!clientX) return;
      
      let x = clientX - rect.left;
      const maxLeft = rect.width - 40;
      const clampedX = Math.max(0, Math.min(maxLeft, x));
      const percent = (clampedX / rect.width) * 100;
      
      sliderHandle.style.left = clampedX + 'px';
      imageOverlay.style.clipPath = `inset(0 ${100 - (clampedX / rect.width) * 100}% 0 0)`;
    }

    function stopDragging() {
      isDragging = false;
      document.removeEventListener('mousemove', handleMove);
      document.removeEventListener('mouseup', stopDragging);
      document.removeEventListener('touchmove', handleMove);
      document.removeEventListener('touchend', stopDragging);
    }

    sliderHandle.addEventListener('mousedown', (e) => {
      isDragging = true;
      document.addEventListener('mousemove', handleMove);
      document.addEventListener('mouseup', stopDragging);
      e.preventDefault();
    });

    sliderHandle.addEventListener('touchstart', (e) => {
      isDragging = true;
      document.addEventListener('touchmove', handleMove);
      document.addEventListener('touchend', stopDragging);
      e.preventDefault();
    });

    // === Share Modal ===
    const shareBtn = document.getElementById('shareBtn');
    const shareModal = document.getElementById('shareModal');
    const closeModal = document.getElementById('closeModal');
    let sharedImageUrl = '';

    shareBtn.addEventListener('click', () => {
      if (!sharedImageUrl) {
        alert('No image to share yet!');
        return;
      }
      shareModal.style.display = 'flex';
    });

    closeModal.addEventListener('click', () => {
      shareModal.style.display = 'none';
    });

    window.addEventListener('click', (e) => {
      if (e.target === shareModal) {
        shareModal.style.display = 'none';
      }
    });

    function shareTo(platform) {
      const text = "I just edited my image with Kamuy - the AI magic is real! ‚ú®";
      const url = encodeURIComponent(window.location.href);
      const imageLink = encodeURIComponent(sharedImageUrl);
      let shareUrl = '';

      switch (platform) {
        case 'twitter':
          shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${imageLink}`;
          break;
        case 'facebook':
          shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${imageLink}`;
          break;
        case 'telegram':
          shareUrl = `https://t.me/share/url?url=${imageLink}&text=${encodeURIComponent(text)}`;
          break;
        case 'whatsapp':
          shareUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(text + ' ' + decodeURIComponent(imageLink))}`;
          break;
      }

      window.open(shareUrl, '_blank', 'noopener,noreferrer');
    }

    // === Rest of the JS ===
    const dropzone = document.getElementById("dropzone");
    const imageInput = document.getElementById("imageInput");
    dropzone.addEventListener("click", () => imageInput.click());

    dropzone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropzone.classList.add("border-blue-500", "bg-blue-50");
    });
    dropzone.addEventListener("dragleave", () => {
      dropzone.classList.remove("border-blue-500", "bg-blue-50");
    });
    dropzone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropzone.classList.remove("border-blue-500", "bg-blue-50");
      if (e.dataTransfer.files.length) {
        imageInput.files = e.dataTransfer.files;
        showPreview(e.dataTransfer.files[0]);
      }
    });

    imageInput.addEventListener("change", () => {
      if (imageInput.files[0]) {
        showPreview(imageInput.files[0]);
      }
    });

    const imagePreview = document.getElementById("imagePreview");
    const previewImg = document.getElementById("previewImg");
    const previewName = document.getElementById("previewName");
    const previewSize = document.getElementById("previewSize");

    function showPreview(file) {
      const reader = new FileReader();
      reader.onload = () => {
        previewImg.src = reader.result;
        previewName.textContent = file.name;
        previewSize.textContent = (file.size / 1024).toFixed(1) + " KB";
        imagePreview.classList.remove("hidden");
      };
      reader.readAsDataURL(file);
    }

    function getStylePrompt() {
      const styles = {
        anime: "in anime style",
        'studio ghibli': "in Studio Ghibli style",
        vintage: "with vintage film effect",
        cyberpunk: "with cyberpunk neon lighting",
        'van gogh': "in the style of Van Gogh, expressive brushstrokes",
        lego: "as a LEGO diorama, plastic texture",
        'pixel art': "in 16-bit pixel art style",
        sketch: "as a pencil sketch, hand-drawn lines",
        glitchcore: "with digital glitch effects, distorted colors",
        'desert mirage': "with desert mirage effect, heat haze"
      };
      return Array.from(selectedStyles)
        .map(s => styles[s] || s)
        .join(", ");
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    const editBtn = document.getElementById("editBtn");
    const loading = document.getElementById("loading");
    const resultDiv = document.getElementById("result");
    const downloadBtn = document.getElementById("downloadBtn");

    editBtn.addEventListener("click", async () => {
      const imageFile = imageInput.files[0];
      const prompt = document.getElementById("prompt").value.trim();
      const stylePrompt = getStylePrompt();

      if (!imageFile || (!prompt && selectedStyles.size === 0)) {
        alert("Please upload an image and enter a prompt or select a style.");
        return;
      }

      try {
        editBtn.classList.add("hidden");
        loading.classList.remove("hidden");
        resultDiv.classList.add("hidden");

        const finalPrompt = stylePrompt ? (prompt ? `${prompt}, ${stylePrompt}` : stylePrompt) : prompt;

        const base64Image = await fileToBase64(imageFile);

        const response = await fetch("/api/edit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            image: base64Image,
            imageName: imageFile.name,
            imageType: imageFile.type,
            prompt: finalPrompt
          })
        });

        const data = await response.json();

        if (data.edited_image_url) {
          beforeImage.src = URL.createObjectURL(imageFile);
          afterImage.src = data.edited_image_url;
          sharedImageUrl = data.edited_image_url;
          
          resultDiv.classList.remove("hidden");

          const container = sliderHandle.parentElement;
          const midPoint = (container.offsetWidth - 40) / 2;
          sliderHandle.style.left = midPoint + 'px';
          imageOverlay.style.clipPath = 'inset(0 50% 0 0)';

          downloadBtn.onclick = () => {
            fetch(data.edited_image_url)
              .then(res => res.blob())
              .then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "kamuy-edited.png";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
              })
              .catch(err => alert("Download failed: " + err.message));
          };
        } else {
          alert("Error: " + (data.error || "Unknown error"));
        }
      } catch (err) {
        alert("Request failed: " + err.message);
      } finally {
        loading.classList.add("hidden");
        editBtn.classList.remove("hidden");
      }
    });

    // Initialize placeholder
    updatePlaceholder();
  </script>
</body>
</html>
