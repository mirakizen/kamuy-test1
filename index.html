<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Kamuy - AI Image Editor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      touch-action: pan-y; 
      transition: background-color 0.3s ease;
    }
    body.dark {
      --bg-primary: #111827;
      --bg-secondary: #1f2937;
      --text-primary: #f9fafb;
      --text-secondary: #d1d5db;
      --border-primary: #374151;
    }
    body:not(.dark) {
      --bg-primary: #f9fafb;
      --bg-secondary: #ffffff;
      --text-primary: #111827;
      --text-secondary: #4b5563;
      --border-primary: #e5e7eb;
    }
    .dark .dropzone, 
    .dark .style-btn, 
    .dark .comparison-container, 
    .dark .resolution-toggle,
    .dark .usage-counter,
    .dark #result,
    .dark .style-grid button {
      --tw-bg-opacity: 1;
      background-color: rgba(31, 41, 54, var(--tw-bg-opacity));
      border-color: #374151;
      color: #f9fafb;
    }
    .dark .style-btn:hover,
    .dark .style-btn.style-active {
      background-color: #2563eb;
    }
    .dropzone { 
      border: 3px dashed #adb5bd; 
      border-radius: 12px; 
      background: #f8f9fa; 
      transition: all 0.2s ease; 
    }
    .dropzone:hover { 
      border-color: #0d6efd; 
      background: #f1f3f5; 
    }
    .spinner { 
      display: inline-block; 
      width: 1em; 
      height: 1em; 
      border: 2px solid #f3f3f3; 
      border-top: 2px solid #fff; 
      border-radius: 50%; 
      animation: spin 1s linear infinite; 
    }
    .style-btn {
      @apply px-3 py-1 text-xs font-medium rounded-full border border-gray-300 transition-all duration-200 cursor-pointer active:scale-95 relative;
    }
    .style-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.5rem;
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      max-width: 300px;
      padding: 12px 16px;
      border-radius: 8px;
      background: #1f2937;
      color: white;
      font-size: 0.875rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      transform: translateX(120%);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 50;
    }
    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }
    .tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #1f2937;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      white-space: nowrap;
      z-index: 10;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }
    .style-btn:hover .tooltip {
      opacity: 1;
      visibility: visible;
    }
    
    /* Enhanced Loading Screen */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 200px;
      padding: 1rem;
    }
    
    .ai-loader {
      position: relative;
      width: 80px;
      height: 80px;
      margin-bottom: 1.5rem;
    }
    
    .loader-ring {
      position: absolute;
      width: 100%;
      height: 100%;
      border: 3px solid transparent;
      border-top-color: #2563eb;
      border-radius: 50%;
      animation: rotate 1.5s linear infinite;
    }
    
    .loader-ring:nth-child(2) {
      border: 3px solid transparent;
      border-right-color: #8b5cf6;
      animation-delay: -0.375s;
    }
    
    .loader-ring:nth-child(3) {
      border: 3px solid transparent;
      border-bottom-color: #06b6d4;
      animation-delay: -0.75s;
    }
    
    .loader-dot {
      position: absolute;
      width: 16px;
      height: 16px;
      background-color: #2563eb;
      border-radius: 50%;
      top: 0;
      left: 50%;
      margin: -8px 0 0 -8px;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    .loader-stages {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .stage {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #cbd5e1;
      transition: all 0.3s ease;
    }
    
    .stage.active {
      background-color: #2563eb;
      transform: scale(1.3);
    }
    
    .loading-text {
      font-size: 1.1rem;
      font-weight: 500;
      color: #1e293b;
      min-height: 1.5rem;
      text-align: center;
    }
    
    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.5); opacity: 0.5; }
    }
    
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @media (max-width: 640px) {
      .style-grid { grid-template-columns: repeat(3, 1fr); }
      .dropzone { padding: 1rem; }
      .spinner { width: 1.2em; height: 1.2em; }
    }

    /* Vertical Reveal Slider */
    .comparison-container {
      position: relative;
      width: 100%;
      height: auto;
      overflow: hidden;
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
      touch-action: none;
    }
    .comparison-image {
      display: block;
      width: 100%;
      height: auto;
    }
    .image-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      pointer-events: none;
    }
    .image-overlay img {
      width: 100%;
      height: auto;
    }
    .slider-handle {
      position: absolute;
      top: 0;
      left: 50%;
      width: 40px;
      height: 100%;
      cursor: ew-resize;
      z-index: 3;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.8);
      border-left: 1px solid #d1d5db;
      border-right: 1px solid #d1d5db;
      touch-action: none;
    }
    .slider-handle::before {
      content: "↔";
      font-size: 24px;
      color: #4b5563;
      opacity: 0.8;
    }
    .slider-instruction {
      text-align: center;
      font-size: 0.875rem;
      color: #4b5563;
      margin-top: 0.25rem;
      font-style: italic;
    }

    /* History Panel */
    .history-panel {
      position: fixed;
      top: 0;
      right: -320px;
      width: 300px;
      height: 100%;
      background: var(--bg-secondary);
      border-left: 1px solid var(--border-primary);
      box-shadow: -4px 0 6px -2px rgba(0,0,0,0.1);
      z-index: 40;
      transition: right 0.3s ease;
      overflow-y: auto;
      padding: 1rem;
    }
    .history-panel.open {
      right: 0;
    }
    .history-item {
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
    }
    .history-item img {
      width: 100%;
      border-radius: 4px;
      margin-bottom: 0.25rem;
    }
    .history-prompt {
      font-size: 0.75rem;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .close-history {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 1.5rem;
      color: var(--text-secondary);
      cursor: pointer;
    }
    .open-history {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background: #2563eb;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      z-index: 30;
      cursor: pointer;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4 sm:p-6">
  <div class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden" id="appContainer">
    <div class="p-6 sm:p-8">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-center text-gray-800">✨ Kamuy</h1>
        <button id="darkModeToggle" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-lg text-sm">
          Dark Mode
        </button>
      </div>
      <p class="text-center text-gray-600 mb-6">AI Image Editing, Powered by Qwen</p>

      <!-- Upload -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Upload Image</label>
        <input type="file" id="imageInput" accept="image/*" class="hidden" />
        <div id="dropzone" class="dropzone w-full p-6 text-center cursor-pointer">
          <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
            <path d="M28 8H12a4 4 0 00-4 4v20m32-20a4 4 0 014 4v20M16 16l16 16m-16 0l16-16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <p class="mt-2 text-sm text-gray-600">Click to upload or drag and drop</p>
          <p class="text-xs text-gray-500">PNG, JPG, GIF up to 50MB</p>
        </div>
        <!-- Preview -->
        <div id="imagePreview" class="hidden mt-4 p-2 border rounded-lg bg-gray-50 flex items-center">
          <img id="previewImg" class="h-20 w-20 object-cover rounded" />
          <div class="ml-3">
            <p id="previewName" class="text-sm font-medium text-gray-900"></p>
            <p id="previewSize" class="text-sm text-gray-500"></p>
          </div>
        </div>
      </div>

      <!-- Prompt -->
      <div class="mb-6">
        <label for="prompt" class="block text-sm font-medium text-gray-700 mb-2">Edit Prompt</label>
        <input type="text" id="prompt" placeholder="Change the car color to red" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
      </div>

      <!-- Style Presets -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Style Presets</label>
        <div class="style-grid">
          <button type="button" class="style-btn" onclick="toggleStyle(this, 'anime')">
            🎨 Anime
            <span class="tooltip">Transform into vibrant anime style</span>
          </button>
          <button type="button" class="style-btn" onclick="toggleStyle(this, 'studio ghibli')">
            🎬 Ghibli
            <span class="tooltip">Studio Ghibli watercolor aesthetic</span>
          </button>
          <button type="button" class="style-btn" onclick="toggleStyle(this, 'picasso')">
            🎨 Picasso
            <span class="tooltip">Cubist abstraction and bold forms</span>
          </button>
          <button type="button" class="style-btn" onclick="toggleStyle(this, 'cyberpunk')">
            🕹️ Cyberpunk
            <span class="tooltip">Neon lights, rain, futuristic</span>
          </button>
          <button type="button" class="style-btn" onclick="toggleStyle(this, 'van gogh')">
            🖼️ Van Gogh
            <span class="tooltip">Expressive brushstrokes, textured</span>
          </button>
          <button type="button" class="style-btn" onclick="toggleStyle(this, 'lego')">
            🧱 LEGO
            <span class="tooltip">Plastic brick diorama style</span>
          </button>
          <button type="button" class="style-btn" onclick="toggleStyle(this, 'pixel art')">
            🎮 Pixel
            <span class="tooltip">16-bit retro video game style</span>
          </button>
          <button type="button" class="style-btn" onclick="toggleStyle(this, 'sketch')">
            🖋️ Sketch
            <span class="tooltip">Pencil drawing with shading</span>
          </button>
          <button type="button" class="style-btn" onclick="toggleStyle(this, 'pixar')">
            🧸 Pixar
            <span class="tooltip">3D animation, soft lighting</span>
          </button>
          <button type="button" class="style-btn" onclick="toggleStyle(this, 'desert mirage')">
            🏜️ Mirage
            <span class="tooltip">Heat haze, desert illusion</span>
          </button>
        </div>
      </div>

      <!-- Edit Button -->
      <button id="editBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
        <i class="fas fa-magic mr-2"></i> Edit Image
      </button>

      <!-- Loading -->
      <div id="loading" class="hidden mt-4 text-center text-gray-600">
        <div class="loading-container">
          <div class="ai-loader">
            <div class="loader-ring"></div>
            <div class="loader-ring"></div>
            <div class="loader-ring"></div>
            <div class="loader-dot"></div>
          </div>
          <div class="loading-text" id="loadingText">Analyzing your image...</div>
          <div class="loader-stages">
            <div class="stage active" id="stage1"></div>
            <div class="stage" id="stage2"></div>
            <div class="stage" id="stage3"></div>
            <div class="stage" id="stage4"></div>
          </div>
        </div>
      </div>

      <!-- Result -->
      <div id="result" class="hidden mt-6">
        <h3 class="text-lg font-medium text-gray-800 mb-2">✨ Edited Image</h3>
        <div class="comparison-container relative">
          <img id="beforeImage" class="comparison-image" src="" alt="Original" />
          <div class="image-overlay" id="imageOverlay">
            <img id="afterImage" class="comparison-image" src="" alt="Edited" />
          </div>
          <div class="slider-handle" id="sliderHandle"></div>
        </div>
        <p class="slider-instruction">Drag left/right to compare before/after</p>
        
        <!-- Download Button -->
        <button id="downloadBtn" class="mt-3 w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
          <i class="fas fa-download mr-2"></i> Download Image
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast">Image uploaded successfully</div>

  <!-- History Panel -->
  <div id="historyPanel" class="history-panel">
    <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Recent Edits</h3>
    <div id="historyList"></div>
    <div class="close-history" id="closeHistory">&times;</div>
  </div>

  <!-- Open History Button -->
  <div id="openHistory" class="open-history">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
  </div>

  <script>
    const selectedStyles = new Set();
    const promptInput = document.getElementById("prompt");
    const defaultPlaceholder = "Change the car color to red";
    const stylePlaceholders = {
      anime: "Make it anime-style with vibrant colors",
      'studio ghibli': "Transform into a Studio Ghibli scene",
      picasso: "in Picasso's cubist style, abstract forms",
      cyberpunk: "Cyberpunk neon lights and rain effects",
      'van gogh': "in the style of Van Gogh, expressive brushstrokes",
      lego: "as a LEGO diorama, plastic texture",
      'pixel art': "in 16-bit pixel art style",
      sketch: "as a pencil sketch, hand-drawn lines",
      pixar: "in Pixar 3D animation style, soft lighting",
      'desert mirage': "with desert mirage effect, heat haze"
    };

    // === Toast Notification System ===
    const toast = document.getElementById('toast');
    const loadingText = document.getElementById('loadingText');
    const stages = [
      document.getElementById('stage1'),
      document.getElementById('stage2'),
      document.getElementById('stage3'),
      document.getElementById('stage4')
    ];

    // Loading stages
    const loadingStages = [
      { text: "Analyzing your image...", stage: 0 },
      { text: "Understanding visual elements...", stage: 1 },
      { text: "Applying AI magic...", stage: 2 },
      { text: "Finalizing your masterpiece...", stage: 3 }
    ];

    // Processing tips
    const processingTips = [
      "Did you know? You can combine styles for unique results!",
      "Pro tip: Be specific in your prompt for better results.",
      "Try using 'Pixar style' for fun character edits!",
      "Editing text? Just describe what you want changed.",
      "You can undo style selections by clicking again.",
      "Large images may take a few extra seconds to process.",
      "Use the slider to compare original vs edited precisely."
    ];

    let currentStage = 0;
    let loadingInterval;

    function showToast(message) {
      toast.textContent = message;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    function startLoadingAnimation() {
      currentStage = 0;
      updateLoadingStage(currentStage);
      
      // Cycle through stages
      loadingInterval = setInterval(() => {
        if (currentStage < loadingStages.length - 1) {
          currentStage++;
          updateLoadingStage(currentStage);
        } else {
          // Rotate tips after all stages
          const randomTip = processingTips[Math.floor(Math.random() * processingTips.length)];
          loadingText.textContent = randomTip;
        }
      }, 1500);
    }

    function updateLoadingStage(stageIndex) {
      loadingText.textContent = loadingStages[stageIndex].text;
      
      // Update stage indicators
      stages.forEach((stage, i) => {
        if (i <= stageIndex) {
          stage.classList.add('active');
        } else {
          stage.classList.remove('active');
        }
      });
    }

    function stopLoadingAnimation() {
      clearInterval(loadingInterval);
      // Reset to first stage for next time
      updateLoadingStage(0);
    }

    function updatePlaceholder() {
      if (promptInput.value) return;
      
      const activeStyles = Array.from(selectedStyles);
      if (activeStyles.length === 0) {
        promptInput.placeholder = defaultPlaceholder;
      } else {
        promptInput.placeholder = stylePlaceholders[activeStyles[0]] || defaultPlaceholder;
      }
    }

    function toggleStyle(button, style) {
      const isActive = button.style.backgroundColor === 'rgb(37, 99, 235)';
      if (isActive) {
        button.style.backgroundColor = '';
        button.style.borderColor = '#d1d5db';
        button.style.color = '#1f2937';
        button.style.transform = 'scale(1)';
        selectedStyles.delete(style);
      } else {
        button.style.backgroundColor = '#2563eb';
        button.style.borderColor = '#2563eb';
        button.style.color = 'white';
        button.style.transform = 'scale(1.05)';
        selectedStyles.add(style);
      }
      updatePlaceholder();
      console.log("Toggled:", style, "Active:", Array.from(selectedStyles));
    }

    promptInput.addEventListener('focus', () => {
      if (!promptInput.value) {
        const activeStyles = Array.from(selectedStyles);
        if (activeStyles.length > 0) {
          promptInput.placeholder = "For example: " + stylePlaceholders[activeStyles[0]];
        }
      }
    });

    promptInput.addEventListener('blur', () => {
      if (!promptInput.value) {
        updatePlaceholder();
      }
    });

    // === Vertical Reveal Slider (Mobile-Fixed) ===
    const beforeImage = document.getElementById('beforeImage');
    const afterImage = document.getElementById('afterImage');
    const imageOverlay = document.getElementById('imageOverlay');
    const sliderHandle = document.getElementById('sliderHandle');
    let isDragging = false;

    function handleMove(e) {
      if (!isDragging) return;
      
      e.preventDefault(); // Prevent scrolling while dragging
      
      const container = sliderHandle.parentElement;
      const rect = container.getBoundingClientRect();
      const clientX = e.clientX || (e.touches && e.touches[0].clientX);
      if (!clientX) return;
      
      let x = clientX - rect.left;
      const maxLeft = rect.width - 40;
      const clampedX = Math.max(0, Math.min(maxLeft, x));
      const percent = (clampedX / rect.width) * 100;
      
      sliderHandle.style.left = clampedX + 'px';
      imageOverlay.style.clipPath = `inset(0 ${100 - (clampedX / rect.width) * 100}% 0 0)`;
    }

    function stopDragging() {
      isDragging = false;
      document.removeEventListener('mousemove', handleMove);
      document.removeEventListener('mouseup', stopDragging);
      document.removeEventListener('touchmove', handleMove);
      document.removeEventListener('touchend', stopDragging);
    }

    sliderHandle.addEventListener('mousedown', (e) => {
      isDragging = true;
      document.addEventListener('mousemove', handleMove);
      document.addEventListener('mouseup', stopDragging);
      e.preventDefault();
    });

    sliderHandle.addEventListener('touchstart', (e) => {
      isDragging = true;
      document.addEventListener('touchmove', handleMove, { passive: false });
      document.addEventListener('touchend', stopDragging);
      e.preventDefault();
    });

    // === Rest of the JS ===
    const dropzone = document.getElementById("dropzone");
    const imageInput = document.getElementById("imageInput");
    dropzone.addEventListener("click", () => imageInput.click());

    dropzone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropzone.classList.add("border-blue-500", "bg-blue-50");
    });
    dropzone.addEventListener("dragleave", () => {
      dropzone.classList.remove("border-blue-500", "bg-blue-50");
    });
    dropzone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropzone.classList.remove("border-blue-500", "bg-blue-50");
      if (e.dataTransfer.files.length) {
        const file = e.dataTransfer.files[0];
        if (file.size > 50 * 1024 * 1024) {
          alert("File is too large. Please upload an image under 50MB.");
          return;
        }
        imageInput.files = e.dataTransfer.files;
        showPreview(file);
        showToast("Image uploaded successfully");
      }
    });

    imageInput.addEventListener("change", () => {
      const file = imageInput.files[0];
      if (file) {
        if (file.size > 50 * 1024 * 1024) {
          alert("File is too large. Please upload an image under 50MB.");
          imageInput.value = ""; // Clear input
          return;
        }
        showPreview(file);
        showToast("Image uploaded successfully");
      }
    });

    const imagePreview = document.getElementById("imagePreview");
    const previewImg = document.getElementById("previewImg");
    const previewName = document.getElementById("previewName");
    const previewSize = document.getElementById("previewSize");

    function showPreview(file) {
      const reader = new FileReader();
      reader.onload = () => {
        previewImg.src = reader.result;
        previewName.textContent = file.name;
        previewSize.textContent = (file.size / (1024*1024)).toFixed(1) + " MB";
        imagePreview.classList.remove("hidden");
      };
      reader.readAsDataURL(file);
    }

    function getStylePrompt() {
      const styles = {
        anime: "in anime style",
        'studio ghibli': "in Studio Ghibli style",
        picasso: "in Picasso's cubist style, abstract forms",
        cyberpunk: "with cyberpunk neon lighting",
        'van gogh': "in the style of Van Gogh, expressive brushstrokes",
        lego: "as a LEGO diorama, plastic texture",
        'pixel art': "in 16-bit pixel art style",
        sketch: "as a pencil sketch, hand-drawn lines",
        pixar: "in Pixar 3D animation style, soft lighting",
        'desert mirage': "with desert mirage effect, heat haze"
      };
      return Array.from(selectedStyles)
        .map(s => styles[s] || s)
        .join(", ");
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    const editBtn = document.getElementById("editBtn");
    const loading = document.getElementById("loading");
    const resultDiv = document.getElementById("result");
    const downloadBtn = document.getElementById("downloadBtn");

    // === Dark Mode Toggle ===
    const darkModeToggle = document.getElementById('darkModeToggle');
    const appContainer = document.getElementById('appContainer');
    const body = document.body;

    // Check user preference
    const prefersDark = localStorage.getItem('kamuy_dark_mode') === 'true';
    if (prefersDark) {
      body.classList.add('dark');
      darkModeToggle.textContent = 'Light Mode';
    }

    darkModeToggle.addEventListener('click', () => {
      body.classList.toggle('dark');
      if (body.classList.contains('dark')) {
        darkModeToggle.textContent = 'Light Mode';
        localStorage.setItem('kamuy_dark_mode', 'true');
      } else {
        darkModeToggle.textContent = 'Dark Mode';
        localStorage.setItem('kamuy_dark_mode', 'false');
      }
    });

    // === History Panel ===
    const historyPanel = document.getElementById('historyPanel');
    const openHistory = document.getElementById('openHistory');
    const closeHistory = document.getElementById('closeHistory');
    const historyList = document.getElementById('historyList');

    openHistory.addEventListener('click', () => {
      historyPanel.classList.add('open');
    });

    closeHistory.addEventListener('click', () => {
      historyPanel.classList.remove('open');
    });

    // Load history from localStorage
    function loadHistory() {
      const history = JSON.parse(localStorage.getItem('kamuy_edit_history') || '[]');
      historyList.innerHTML = '';
      if (history.length === 0) {
        historyList.innerHTML = '<p class="text-sm text-gray-500">No edits yet</p>';
      }
      history.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
          <img src="${item.thumbnail}" alt="Edit" />
          <div class="history-prompt">${item.prompt}</div>
          <small class="text-xs text-gray-500">${new Date(item.date).toLocaleString()}</small>
        `;
        div.onclick = () => {
          beforeImage.src = item.original;
          afterImage.src = item.edited;
          resultDiv.classList.remove('hidden');
          historyPanel.classList.remove('open');
          showToast("Loaded from history!");
        };
        historyList.appendChild(div);
      });
    }

    // Save to history
    function saveToHistory(original, edited, prompt) {
      const history = JSON.parse(localStorage.getItem('kamuy_edit_history') || '[]');
      const canvas = document.createElement('canvas');
      const img = new Image();
      img.onload = () => {
        canvas.width = 100;
        canvas.height = 100;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, 100, 100);
        const thumbnail = canvas.toDataURL('image/jpeg', 0.7);

        const newItem = {
          original,
          edited,
          thumbnail,
          prompt,
          date: new Date().toISOString()
        };
        history.unshift(newItem);
        // Keep only last 5
        localStorage.setItem('kamuy_edit_history', JSON.stringify(history.slice(0, 5)));
        loadHistory();
      };
      img.src = edited;
    }

    // Initialize history
    loadHistory();

    editBtn.addEventListener("click", async () => {
      const imageFile = imageInput.files[0];
      const prompt = document.getElementById("prompt").value.trim();
      const stylePrompt = getStylePrompt();

      if (!imageFile || (!prompt && selectedStyles.size === 0)) {
        alert("Please upload an image and enter a prompt or select a style.");
        return;
      }

      if (imageFile.size > 50 * 1024 * 1024) {
        alert("Image too large! Please upload an image under 50MB.");
        return;
      }

      try {
        editBtn.classList.add("hidden");
        loading.classList.remove("hidden");
        resultDiv.classList.add("hidden");
        
        // Start loading animation
        startLoadingAnimation();

        const finalPrompt = stylePrompt ? (prompt ? `${prompt}, ${stylePrompt}` : stylePrompt) : prompt;

        const base64Image = await fileToBase64(imageFile);

        const response = await fetch("/api/edit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            image: base64Image,
            imageName: imageFile.name,
            imageType: imageFile.type,
            prompt: finalPrompt
          })
        });

        const data = await response.json();

        if (data.edited_image_url) {
          const originalUrl = URL.createObjectURL(imageFile);
          beforeImage.src = originalUrl;
          afterImage.src = data.edited_image_url;
          
          resultDiv.classList.remove("hidden");

          // Reset slider to 50%
          const container = sliderHandle.parentElement;
          const midPoint = (container.offsetWidth - 40) / 2;
          sliderHandle.style.left = midPoint + 'px';
          imageOverlay.style.clipPath = 'inset(0 50% 0 0)';

          downloadBtn.onclick = () => {
            fetch(data.edited_image_url)
              .then(res => res.blob())
              .then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "kamuy-edited.png";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast("Download started");
              })
              .catch(err => alert("Download failed: " + err.message));
          };

          // Save to history
          saveToHistory(originalUrl, data.edited_image_url, finalPrompt);

          showToast("Edit completed! 🎉");
        } else {
          alert("Error: " + (data.error || "Unknown error"));
        }
      } catch (err) {
        alert("Request failed: " + err.message);
      } finally {
        loading.classList.add("hidden");
        editBtn.classList.remove("hidden");
        // Stop loading animation
        stopLoadingAnimation();
      }
    });

    // Initialize placeholder
    updatePlaceholder();
  </script>
</body>
</html>
