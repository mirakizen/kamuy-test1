<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kamuy - AI Image Editor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .dropzone { border: 3px dashed #adb5bd; border-radius: 12px; background: #f8f9fa; }
    .dropzone:hover { border-color: #0d6efd; background: #f1f3f5; }
    .spinner { display: inline-block; width: 1em; height: 1em; border: 2px solid #f3f3f3; border-top: 2px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; }
    .style-btn {
      @apply px-3 py-1 text-xs font-medium rounded-full border transition-all duration-200 cursor-pointer;
    }
    .style-btn.active {
      @apply bg-blue-600 text-white border-blue-600;
    }
    .style-btn:not(.active):hover {
      @apply border-blue-500 bg-blue-50;
    }
    .style-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.5rem;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @media (max-width: 640px) {
      .style-grid { grid-template-columns: repeat(3, 1fr); }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
    <div class="p-8">
      <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">âœ¨ Kamuy</h1>
      <p class="text-center text-gray-600 mb-6">AI Image Editing, Powered by Qwen</p>

      <!-- Upload -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Upload Image</label>
        <input type="file" id="imageInput" accept="image/*" class="hidden" />
        <div id="dropzone" class="dropzone w-full p-6 text-center cursor-pointer">
          <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
            <path d="M28 8H12a4 4 0 00-4 4v20m32-20a4 4 0 014 4v20M16 16l16 16m-16 0l16-16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <p class="mt-2 text-sm text-gray-600">Click to upload or drag and drop</p>
          <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
        </div>
        <!-- Preview -->
        <div id="imagePreview" class="hidden mt-4 p-2 border rounded-lg bg-gray-50 flex items-center">
          <img id="previewImg" class="h-20 w-20 object-cover rounded" />
          <div class="ml-3">
            <p id="previewName" class="text-sm font-medium text-gray-900"></p>
            <p id="previewSize" class="text-sm text-gray-500"></p>
          </div>
        </div>
      </div>

      <!-- Prompt -->
      <div class="mb-6">
        <label for="prompt" class="block text-sm font-medium text-gray-700 mb-2">Edit Prompt</label>
        <input type="text" id="prompt" placeholder="Change the car color to red" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
      </div>

      <!-- Style Presets -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">Style Presets</label>
        <div class="style-grid">
          <button type="button" class="style-btn border-gray-300" onclick="toggleStyle(this, 'anime')">ğŸ¨ Anime</button>
          <button type="button" class="style-btn border-gray-300" onclick="toggleStyle(this, 'studio ghibli')">ğŸ¬ Ghibli</button>
          <button type="button" class="style-btn border-gray-300" onclick="toggleStyle(this, 'vintage')">ğŸ“» Vintage</button>
          <button type="button" class="style-btn border-gray-300" onclick="toggleStyle(this, 'cyberpunk')">ğŸ•¹ï¸ Cyberpunk</button>
          <button type="button" class="style-btn border-gray-300" onclick="toggleStyle(this, 'van gogh')">ğŸ–¼ï¸ Van Gogh</button>
          <button type="button" class="style-btn border-gray-300" onclick="toggleStyle(this, 'lego')">ğŸ§± LEGO</button>
          <button type="button" class="style-btn border-gray-300" onclick="toggleStyle(this, 'pixel art')">ğŸ® Pixel</button>
          <button type="button" class="style-btn border-gray-300" onclick="toggleStyle(this, 'sketch')">ğŸ–‹ï¸ Sketch</button>
          <button type="button" class="style-btn border-gray-300" onclick="toggleStyle(this, 'glitchcore')">ğŸŒŒ Glitch</button>
          <button type="button" class="style-btn border-gray-300" onclick="toggleStyle(this, 'desert mirage')">ğŸœï¸ Mirage</button>
        </div>
      </div>

      <!-- Edit Button -->
      <button id="editBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
        <i class="fas fa-magic mr-2"></i> Edit Image
      </button>

      <!-- Loading -->
      <div id="loading" class="hidden mt-4 text-center text-gray-600">
        <div class="spinner mr-2"></div> Editing your image...
      </div>

      <!-- Result -->
      <div id="result" class="hidden mt-6">
        <h3 class="text-lg font-medium text-gray-800 mb-2">âœ¨ Edited Image</h3>
        <img id="resultImage" class="w-full rounded-lg border shadow-sm"/>
        <button id="downloadBtn" class="mt-3 w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
          <i class="fas fa-download mr-2"></i> Download Image
        </button>
      </div>
    </div>
  </div>

  <script>
    const imageInput = document.getElementById("imageInput");
    const dropzone = document.getElementById("dropzone");
    const promptInput = document.getElementById("prompt");
    const editBtn = document.getElementById("editBtn");
    const loading = document.getElementById("loading");
    const resultDiv = document.getElementById("result");
    const resultImage = document.getElementById("resultImage");
    const downloadBtn = document.getElementById("downloadBtn");
    const imagePreview = document.getElementById("imagePreview");
    const previewImg = document.getElementById("previewImg");
    const previewName = document.getElementById("previewName");
    const previewSize = document.getElementById("previewSize");

    // Selected styles
    const selectedStyles = new Set();

    // Open file picker
    dropzone.addEventListener("click", () => imageInput.click());

    // Drag & drop
    dropzone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropzone.classList.add("border-blue-500", "bg-blue-50");
    });
    dropzone.addEventListener("dragleave", () => {
      dropzone.classList.remove("border-blue-500", "bg-blue-50");
    });
    dropzone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropzone.classList.remove("border-blue-500", "bg-blue-50");
      if (e.dataTransfer.files.length) {
        imageInput.files = e.dataTransfer.files;
        showPreview(e.dataTransfer.files[0]);
      }
    });

    // File select
    imageInput.addEventListener("change", () => {
      if (imageInput.files[0]) {
        showPreview(imageInput.files[0]);
      }
    });

    function showPreview(file) {
      const reader = new FileReader();
      reader.onload = () => {
        previewImg.src = reader.result;
        previewName.textContent = file.name;
        previewSize.textContent = (file.size / 1024).toFixed(1) + " KB";
        imagePreview.classList.remove("hidden");
      };
      reader.readAsDataURL(file);
    }

    function toggleStyle(button, style) {
      const isActive = button.classList.contains("active");
      if (isActive) {
        button.classList.remove("active");
        selectedStyles.delete(style);
      } else {
        button.classList.add("active");
        selectedStyles.add(style);
      }
      console.log("Selected styles:", Array.from(selectedStyles)); // Debug
    }

    function getStylePrompt() {
      const styles = {
        anime: "in anime style",
        'studio ghibli': "in Studio Ghibli style",
        vintage: "with vintage film effect",
        cyberpunk: "with cyberpunk neon lighting",
        'van gogh': "in the style of Van Gogh, expressive brushstrokes",
        lego: "as a LEGO diorama, plastic texture",
        'pixel art': "in 16-bit pixel art style",
        sketch: "as a pencil sketch, hand-drawn lines",
        glitchcore: "with digital glitch effects, distorted colors",
        'desert mirage': "with desert mirage effect, heat haze"
      };
      return Array.from(selectedStyles)
        .map(s => styles[s] || s)
        .join(", ");
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    editBtn.addEventListener("click", async () => {
      const imageFile = imageInput.files[0];
      const prompt = promptInput.value.trim();
      const stylePrompt = getStylePrompt();

      if (!imageFile || (!prompt && selectedStyles.size === 0)) {
        alert("Please upload an image and enter a prompt or select a style.");
        return;
      }

      try {
        editBtn.classList.add("hidden");
        loading.classList.remove("hidden");
        resultDiv.classList.add("hidden");

        const finalPrompt = stylePrompt ? (prompt ? `${prompt}, ${stylePrompt}` : stylePrompt) : prompt;

        const base64Image = await fileToBase64(imageFile);

        const response = await fetch("/api/edit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            image: base64Image,
            imageName: imageFile.name,
            imageType: imageFile.type,
            prompt: finalPrompt
          })
        });

        const data = await response.json();

        if (data.edited_image_url) {
          resultImage.src = data.edited_image_url;
          resultDiv.classList.remove("hidden");

          downloadBtn.onclick = () => {
            fetch(data.edited_image_url)
              .then(res => res.blob())
              .then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "kamuy-edited.png";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
              })
              .catch(err => alert("Download failed: " + err.message));
          };
        } else {
          alert("Error: " + (data.error || "Unknown error"));
        }
      } catch (err) {
        alert("Request failed: " + err.message);
      } finally {
        loading.classList.add("hidden");
        editBtn.classList.remove("hidden");
      }
    });
  </script>
</body>
</html>
